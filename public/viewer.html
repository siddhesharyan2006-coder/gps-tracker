<!DOCTYPE html>
<html>

<head>
    <title>Live Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #map {
            height: 100vh;
            width: 100vw;
        }

        .panel {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.65);
            color: #fff;
            padding: 10px 14px;
            border-radius: 14px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            z-index: 999;
            max-width: 92vw;
            text-align: center;
        }

        .bottom {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            padding: 10px 14px;
            border-radius: 14px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            z-index: 999;
            max-width: 92vw;
        }
    </style>
</head>

<body>
    <div class="panel">ðŸŸ¢ START / ðŸ”´ DESTINATION Live Viewer</div>
    <div id="map"></div>
    <div class="bottom" id="info">Waiting for trip...</div>

    <script>
        const SERVER_URL = "https://gps-tracker-api-wqoy.onrender.com";

        const map = L.map("map").setView([0, 0], 2);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

        let pathLine;
        let liveMarker, startMarker, destMarker;
        const iconToUse = (trip.stoppedAt ? liveRedIcon : liveBlueIcon);

        // LIVE marker (blue while moving, red after STOP)
        if (!liveMarker) {
            liveMarker = L.marker([last.latitude, last.longitude], { icon: iconToUse })
                .addTo(map)
                .bindPopup(trip.stoppedAt ? "ðŸ”´ LAST LOCATION" : "ðŸ”µ LIVE");
        } else {
            liveMarker.setLatLng([last.latitude, last.longitude]);
            liveMarker.setIcon(iconToUse); // âœ… turns red after STOP
        }

        function kmph(speedMs) {
            if (!speedMs) return 0;
            return (speedMs * 3.6);
        }

        async function update() {
            const [locRes, tripRes] = await Promise.all([
                fetch(`${SERVER_URL}/locations`),
                fetch(`${SERVER_URL}/trip`)
            ]);

            const data = await locRes.json();
            const trip = await tripRes.json();

            if (!trip.startedAt) {
                document.getElementById("info").innerHTML = "Trip not started yet. Ask tracker to press START.";
                return;
            }

            if (!data || data.length === 0) {
                document.getElementById("info").innerHTML = `Trip started at: ${new Date(trip.startedAt).toLocaleString()}<br>Waiting for first GPS point...`;
                return;
            }

            const latlngs = data.map(p => [p.latitude, p.longitude]);
            const last = data[data.length - 1];

            // START marker from trip.startPoint (fallback to first point)
            const sp = trip.startPoint || { latitude: data[0].latitude, longitude: data[0].longitude };
            if (!startMarker) {
                startMarker = L.marker([sp.latitude, sp.longitude]).addTo(map).bindPopup("ðŸŸ¢ START");
            } else {
                startMarker.setLatLng([sp.latitude, sp.longitude]);
            }

            // LIVE marker
            if (!liveMarker) {
                liveMarker = L.marker([last.latitude, last.longitude]).addTo(map).bindPopup("ðŸ”µ LIVE");
            } else {
                liveMarker.setLatLng([last.latitude, last.longitude]);
            }

            // DESTINATION marker appears only after STOP
            if (trip.stoppedAt && trip.stopPoint) {
                const dp = trip.stopPoint;
                if (!destMarker) {
                    destMarker = L.marker([dp.latitude, dp.longitude]).addTo(map).bindPopup("ðŸ”´ DESTINATION");
                } else {
                    destMarker.setLatLng([dp.latitude, dp.longitude]);
                }
            }

            // route polyline
            if (!pathLine) {
                pathLine = L.polyline(latlngs).addTo(map);
            } else {
                pathLine.setLatLngs(latlngs);
            }

            map.setView([last.latitude, last.longitude], 16);

            const speedText = `${kmph(last.speed).toFixed(2)} km/h`;
            const lastTime = new Date(last.timestamp).toLocaleString();

            document.getElementById("info").innerHTML = `
      <b>Started:</b> ${new Date(trip.startedAt).toLocaleString()}<br>
      <b>Stopped:</b> ${trip.stoppedAt ? new Date(trip.stoppedAt).toLocaleString() : "Not yet"}<br>
      <b>Live:</b> ${last.latitude.toFixed(6)}, ${last.longitude.toFixed(6)}<br>
      <b>Speed:</b> ${speedText}<br>
      <b>Last Update:</b> ${lastTime}<br>
      <b>Points:</b> ${data.length}
    `;
        }

        setInterval(update, 3000);
        update();
    </script>
</body>

</html>