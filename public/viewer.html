<!DOCTYPE html>
<html>

<head>
    <title>Live Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #map {
            height: 100vh;
            width: 100vw;
        }

        .panel {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            padding: 10px 14px;
            border-radius: 14px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            z-index: 999;
            max-width: 92vw;
            text-align: center;
        }

        .bottom {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            padding: 10px 14px;
            border-radius: 14px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            z-index: 999;
            max-width: 92vw;
        }
    </style>
</head>

<body>
    <div class="panel">üìç Live Tracking Viewer</div>
    <div id="map"></div>
    <div class="bottom" id="info">Waiting for location...</div>

    <script>
        const SERVER_URL = "https://gps-tracker-api-wqoy.onrender.com";

        const map = L.map("map").setView([0, 0], 2);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

        let pathLine;
        let liveMarker, startMarker, stopMarker;

        function kmph(speedMs) {
            if (!speedMs) return 0;
            return (speedMs * 3.6);
        }

        async function update() {
            const res = await fetch(`${SERVER_URL}/locations`);
            const data = await res.json();

            if (!data || data.length === 0) return;

            const latlngs = data.map(p => [p.latitude, p.longitude]);
            const first = data[0];
            const last = data[data.length - 1];

            // start marker
            if (!startMarker) {
                startMarker = L.marker([first.latitude, first.longitude]).addTo(map).bindPopup("Start");
            } else {
                startMarker.setLatLng([first.latitude, first.longitude]);
            }

            // live marker
            if (!liveMarker) {
                liveMarker = L.marker([last.latitude, last.longitude]).addTo(map).bindPopup("Live");
            } else {
                liveMarker.setLatLng([last.latitude, last.longitude]);
            }

            // stop marker = latest point too (shows where you last stopped/seen)
            if (!stopMarker) {
                stopMarker = L.marker([last.latitude, last.longitude]).addTo(map).bindPopup("Last Seen");
            } else {
                stopMarker.setLatLng([last.latitude, last.longitude]);
            }

            // polyline path
            if (!pathLine) {
                pathLine = L.polyline(latlngs).addTo(map);
            } else {
                pathLine.setLatLngs(latlngs);
            }

            map.setView([last.latitude, last.longitude], 16);

            const speedText = `${kmph(last.speed).toFixed(2)} km/h`;
            const timeText = new Date(last.timestamp).toLocaleString();

            document.getElementById("info").innerHTML = `
      <b>Last Location:</b> ${last.latitude.toFixed(6)}, ${last.longitude.toFixed(6)}<br>
      <b>Speed:</b> ${speedText}<br>
      <b>Time:</b> ${timeText}<br>
      <b>Points:</b> ${data.length}
    `;
        }

        setInterval(update, 3000);
        update();
    </script>
</body>

</html>